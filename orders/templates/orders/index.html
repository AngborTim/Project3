{% extends "orders/base.html" %}
{% block title %}Pizza Houzze{% endblock %}

{% block main %}

<main class="container-fluid disabled" style="position: fixed;">
<div class="row">
  <div class="col-8" id="extra_nav">
    <div>
      <h4 class="text-center">Hello and welcome, dear {% if user == 'none' %}Guest{% else %} {{user.username}}{% endif %}!</h4>
      <h5 class="text-center">How would you like to feast today?</h5>
    </div>
  </div>
  <div class="col-4">
    <div>
      <nav class="navbar navbar-expand-lg">
        <span class="navbar-brand p-2" id="order_header">Shopping cart</span>
      </nav>
    </div>
  </div>
</div>


    <div class="row">
        <div id="scrl" class="col-8" style="overflow: scroll;">
        <table class="table table-bordered table-hover" style="width:90%;">
          {% for key, pza in allpizza.items %}
          <tr>
            <th id='{{ key|cut:" " }}' scope="col" class="text-center bg-info" colspan="3">{{ key }}</th>
          </tr>
          <tr>
            <th scope="col"></th>
            <th scope="col">Small</th>
            <th scope="col">Large</th>
          </tr>
            {% for piz in pza %}
            <tr>
              <td>{{piz.name}}</td>
              <td>
                <div class="d-flex justify-content-between">{{piz.priceSmall}}
                  <button type="button" data-item_pk="{{piz.pk}}" data-item_size="1" data-item_price="{{piz.priceSmall}}" class="btn_add badge badge-primary badge-pill">Add</button>
                </div>
              </td>
              <td>
                <div class="d-flex justify-content-between">{{piz.priceLarge}}
                  <button type="button" data-item_pk="{{piz.pk}}" data-item_size="2"  data-item_price="{{piz.priceLarge}}" class="btn_add badge badge-primary badge-pill">Add</button>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% endfor%}

          {% for key, s_p in salads_pasta.items %}
          <tr>
            <th id='{{ key|cut:" " }}' scope="col" class="text-center bg-info" colspan="3">{{ key }}</th>
          </tr>
            {% for sal_pas in s_p %}
            <tr>
              <td colspan="2">{{sal_pas.name}}</td>
              <td>
                <div class="d-flex justify-content-between">{{sal_pas.priceSmall}}
                  <button type="button" data-item_pk="{{sal_pas.pk}}" data-item_size="3" data-item_price="{{sal_pas.priceSmall}}" class="btn_add badge badge-primary badge-pill">Add</button>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% endfor%}
        </table>
      </div>

      <div class="col-4" id="order_list">
        <table class="table table-sm" id="order_t">
          <tr class="text-center">
            <th id="total" class="h2" colspan="2">
               Total: ${{ total }}
             </th>
             <th>
               <button type="button" data-order_id="1" data-user_id="1" id="checkout" name="checkout" class="btn btn-success">Checkout</button>
             </th>
          </tr>

        {% if current_order_list %}
          {% for item in current_order_list  %}
          <tr id="item-{{ item.pk }}" class="item_block">
            <td>
              <button type="button" class="close delete_item" data-item_id="{{ item.pk }}" data-url="{% url 'remove_item_from_cart' %}"  data-order_id = "{{item.order_id.order_id}}">
                <span title="Delete an item">&times;</span>
              </button>
            </td>
            <td>{{item.itemSize.sizeName}} {{item.item.itemtype.name}} {{item.item.name}}</td>
            <td>${{item.itemPrice}}</td>
          </tr>
          {% endfor %}
        {% endif %}
          <tr>
            <td>
              <button type="button" class="close delete_item" data-item_id="1">
                <span title="Delete an item">&times;</span>
              </button>
            </td>
            <td>Pizza<br />
              <select name="select" data-topping-1>
                <option value="value1" disabled selected>Choose toppings</option>
                {% for top in pizza_topings %}
                  <option value="{{ top.pk }}">{{ top.name}}</option>
                {% endfor%}
              </select>
              <select name="select" data-topping-2>
                <option value="value1" disabled selected>Choose toppings</option>
                {% for top in pizza_topings %}
                  <option value="{{ top.pk }}">{{ top.name}}</option>
                {% endfor%}
              </select>
              <select name="select" data-topping-3>
                <option value="value1" disabled selected>Choose toppings</option>
                {% for top in pizza_topings %}
                  <option value="{{ top.pk }}">{{ top.name}}</option>
                {% endfor%}
              </select>


            </td>
            <td>$10</td>
          </tr>

        </table>

      </div>
  </div>
</main>


<script type="text/javascript">

  document.addEventListener('DOMContentLoaded', function(){

    document.querySelectorAll('.btn_add').forEach(btn_add => {
      btn_add.onclick = () => {
        var item_pk = btn_add.dataset.item_pk;
        var size = btn_add.dataset.item_size;
        var item_price = btn_add.dataset.item_price;
        var csrftoken = $('input[name=csrfmiddlewaretoken]').val();

        var ind = 1;
        $.post("{% url 'add_to_cart' %}", {
          item_pk: item_pk,
          size: size,
          price : item_price,
          user_id: {{ user_id }},
          csrfmiddlewaretoken: csrftoken }, function(){
            document.querySelector('.spinner-border').classList.remove('d-none');
            document.querySelector('main').setAttribute( 'style', 'position: fixed; opacity:50% !important');
          })
          .done(function( data ) {

            // все получилось
            if (data['status'] == "OK"){
              var cart = document.getElementById('order_t');
              var item_tr = document.createElement("tr");

              var item_td_del = document.createElement("td");
              var btn = document.createElement("button");
              btn.classList.add("close");
              btn.dataset.item_id = data['result'].item_id;
              btn.dataset.order_id = data['result'].order_id;
              var btn_span = document.createElement("span");
              btn_span.title = "Delete an item";
              btn_span.innerHTML = "&times;";
              btn.appendChild(btn_span);
              item_td_del.appendChild(btn);

              var item_td = document.createElement("td");
              if (data['result'].type == 'Pasta' || data['result'].type ==  'Salads'){
                var txt = data['result'].type + '"' + data['result'].name + '"';
              }
              else if (data['result'].type == 'Sicilian Pizza' || data['result'].type ==  'Regular Pizza'){
                var txt = data['result'].size[0].toUpperCase() + data['result'].size.slice(1)+ ' "' + data['result'].type+ '" '+ data['result'].name;
              }
              else {
                var txt = data['result'].size[0].toUpperCase() + data['result'].size.slice(1)+ ' "' + data['result'].type+ '"';
              }
              var new_item = document.createTextNode( txt );
              item_td.appendChild(new_item);


              var item_td_price = document.createElement("td");
              var price_text = document.createTextNode("$" + data['result'].price);
              item_td_price.appendChild(price_text);

              item_tr.appendChild(item_td_del);
              item_tr.appendChild(item_td);
              item_tr.appendChild(item_td_price);
              cart.appendChild(item_tr);
              document.getElementById('total').innerHTML = ' Total: $' + data['result'].total.toFixed(2);
            }
            else {
              alert('oblom');
            }

        })
        .always(function(){
          document.querySelector('.spinner-border').classList.add('d-none');
          document.querySelector('main').setAttribute( 'style',  'position: fixed; opacity:100% !important');
        })
      };
    });
});
</script>
{% endblock %}
